!function(e,r){"object"==typeof exports&&"object"==typeof module?module.exports=r(require("dzhyun-connection")):"function"==typeof define&&define.amd?define(["dzhyun-connection"],r):"object"==typeof exports?exports.DzhyunTokenManager=r(require("dzhyun-connection")):e.DzhyunTokenManager=r(e.connection)}(this,function(e){return function(e){function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}var t={};return r.m=e,r.c=t,r.i=function(e){return e},r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},r.p="",r(r.s=2)}([function(e,r,t){"use strict";var n;!function(o){function a(e,r,t){var n,o,a,i,u,s,c,g,b,E=0,w=[],T=0,m=!1,F=[],R=[],B=!1;if(t=t||{},n=t.encoding||"UTF8",b=t.numRounds||1,a=v(r,n),b!==parseInt(b,10)||1>b)throw Error("numRounds must a integer >= 1");if("SHA-1"!==e)throw Error("Chosen SHA variant is not supported");u=512,s=k,c=A,i=160,g=function(e){return e.slice()},o=y(e),this.setHMACKey=function(r,t,a){var f;if(!0===m)throw Error("HMAC key already set");if(!0===B)throw Error("Cannot set HMAC key after calling update");if(n=(a||{}).encoding||"UTF8",t=v(t,n)(r),r=t.binLen,t=t.value,f=u>>>3,a=f/4-1,f<r/8){for(t=c(t,r,0,y(e),i);t.length<=a;)t.push(0);t[a]&=4294967040}else if(f>r/8){for(;t.length<=a;)t.push(0);t[a]&=4294967040}for(r=0;r<=a;r+=1)F[r]=909522486^t[r],R[r]=1549556828^t[r];o=s(F,o),E=u,m=!0},this.update=function(e){var r,t,n,i=0,c=u>>>5;for(r=a(e,w,T),e=r.binLen,t=r.value,r=e>>>5,n=0;n<r;n+=c)i+u<=e&&(o=s(t.slice(n,n+c),o),i+=u);E+=i,w=t.slice(i>>>5),T=e%u,B=!0},this.getHash=function(r,t){var n,a,u,s;if(!0===m)throw Error("Cannot call getHash after setting HMAC key");switch(u=l(t),r){case"HEX":n=function(e){return f(e,i,u)};break;case"B64":n=function(e){return h(e,i,u)};break;case"BYTES":n=function(e){return p(e,i)};break;case"ARRAYBUFFER":try{a=new ArrayBuffer(0)}catch(e){throw Error("ARRAYBUFFER not supported by this environment")}n=function(e){return d(e,i)};break;default:throw Error("format must be HEX, B64, BYTES, or ARRAYBUFFER")}for(s=c(w.slice(),T,E,g(o),i),a=1;a<b;a+=1)s=c(s,i,0,y(e),i);return n(s)},this.getHMAC=function(r,t){var n,a,v,b;if(!1===m)throw Error("Cannot call getHMAC without first setting HMAC key");switch(v=l(t),r){case"HEX":n=function(e){return f(e,i,v)};break;case"B64":n=function(e){return h(e,i,v)};break;case"BYTES":n=function(e){return p(e,i)};break;case"ARRAYBUFFER":try{n=new ArrayBuffer(0)}catch(e){throw Error("ARRAYBUFFER not supported by this environment")}n=function(e){return d(e,i)};break;default:throw Error("outputFormat must be HEX, B64, BYTES, or ARRAYBUFFER")}return a=c(w.slice(),T,E,g(o),i),b=s(R,y(e)),b=c(a,i,u,b,i),n(b)}}function i(e,r,t){var n,o,a,i,u,s=e.length;if(r=r||[0],t=t||0,u=t>>>3,0!=s%2)throw Error("String of HEX type must be in byte increments");for(n=0;n<s;n+=2){if(o=parseInt(e.substr(n,2),16),isNaN(o))throw Error("String of HEX type contains invalid characters");for(i=(n>>>1)+u,a=i>>>2;r.length<=a;)r.push(0);r[a]|=o<<8*(3-i%4)}return{value:r,binLen:4*s+t}}function u(e,r,t){var n,o,a,i,u=[],u=r||[0];for(t=t||0,o=t>>>3,n=0;n<e.length;n+=1)r=e.charCodeAt(n),i=n+o,a=i>>>2,u.length<=a&&u.push(0),u[a]|=r<<8*(3-i%4);return{value:u,binLen:8*e.length+t}}function s(e,r,t){var n,o,a,i,u,s,c=[],f=0,c=r||[0];if(t=t||0,r=t>>>3,-1===e.search(/^[a-zA-Z0-9=+\/]+$/))throw Error("Invalid character in base-64 string");if(o=e.indexOf("="),e=e.replace(/\=/g,""),-1!==o&&o<e.length)throw Error("Invalid '=' found in base-64 string");for(o=0;o<e.length;o+=4){for(u=e.substr(o,4),a=i=0;a<u.length;a+=1)n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(u[a]),i|=n<<18-6*a;for(a=0;a<u.length-1;a+=1){for(s=f+r,n=s>>>2;c.length<=n;)c.push(0);c[n]|=(i>>>16-8*a&255)<<8*(3-s%4),f+=1}}return{value:c,binLen:8*f+t}}function c(e,r,t){var n,o,a,i=[],i=r||[0];for(t=t||0,n=t>>>3,r=0;r<e.byteLength;r+=1)a=r+n,o=a>>>2,i.length<=o&&i.push(0),i[o]|=e[r]<<8*(3-a%4);return{value:i,binLen:8*e.byteLength+t}}function f(e,r,t){var n="";r/=8;var o,a;for(o=0;o<r;o+=1)a=e[o>>>2]>>>8*(3-o%4),n+="0123456789abcdef".charAt(a>>>4&15)+"0123456789abcdef".charAt(15&a);return t.outputUpper?n.toUpperCase():n}function h(e,r,t){var n,o,a,i="",u=r/8;for(n=0;n<u;n+=3)for(o=n+1<u?e[n+1>>>2]:0,a=n+2<u?e[n+2>>>2]:0,a=(e[n>>>2]>>>8*(3-n%4)&255)<<16|(o>>>8*(3-(n+1)%4)&255)<<8|a>>>8*(3-(n+2)%4)&255,o=0;4>o;o+=1)i+=8*n+6*o<=r?"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a>>>6*(3-o)&63):t.b64Pad;return i}function p(e,r){var t,n,o="",a=r/8;for(t=0;t<a;t+=1)n=e[t>>>2]>>>8*(3-t%4)&255,o+=String.fromCharCode(n);return o}function d(e,r){var t,n=r/8,o=new ArrayBuffer(n);for(t=0;t<n;t+=1)o[t]=e[t>>>2]>>>8*(3-t%4)&255;return o}function l(e){var r={outputUpper:!1,b64Pad:"=",shakeLen:-1};if(e=e||{},r.outputUpper=e.outputUpper||!1,!0===e.hasOwnProperty("b64Pad")&&(r.b64Pad=e.b64Pad),"boolean"!=typeof r.outputUpper)throw Error("Invalid outputUpper formatting option");if("string"!=typeof r.b64Pad)throw Error("Invalid b64Pad formatting option");return r}function v(e,r){var t;switch(r){case"UTF8":case"UTF16BE":case"UTF16LE":break;default:throw Error("encoding must be UTF8, UTF16BE, or UTF16LE")}switch(e){case"HEX":t=i;break;case"TEXT":t=function(e,t,n){var o,a,i,u,s,c=[],f=[],h=0,c=t||[0];if(t=n||0,i=t>>>3,"UTF8"===r)for(o=0;o<e.length;o+=1)for(n=e.charCodeAt(o),f=[],128>n?f.push(n):2048>n?(f.push(192|n>>>6),f.push(128|63&n)):55296>n||57344<=n?f.push(224|n>>>12,128|n>>>6&63,128|63&n):(o+=1,n=65536+((1023&n)<<10|1023&e.charCodeAt(o)),f.push(240|n>>>18,128|n>>>12&63,128|n>>>6&63,128|63&n)),a=0;a<f.length;a+=1){for(s=h+i,u=s>>>2;c.length<=u;)c.push(0);c[u]|=f[a]<<8*(3-s%4),h+=1}else if("UTF16BE"===r||"UTF16LE"===r)for(o=0;o<e.length;o+=1){for(n=e.charCodeAt(o),"UTF16LE"===r&&(a=255&n,n=a<<8|n>>>8),s=h+i,u=s>>>2;c.length<=u;)c.push(0);c[u]|=n<<8*(2-s%4),h+=2}return{value:c,binLen:8*h+t}};break;case"B64":t=s;break;case"BYTES":t=u;break;case"ARRAYBUFFER":try{t=new ArrayBuffer(0)}catch(e){throw Error("ARRAYBUFFER not supported by this environment")}t=c;break;default:throw Error("format must be HEX, TEXT, B64, BYTES, or ARRAYBUFFER")}return t}function g(e,r){return e<<r|e>>>32-r}function b(e,r){var t=(65535&e)+(65535&r);return((e>>>16)+(r>>>16)+(t>>>16)&65535)<<16|65535&t}function E(e,r,t,n,o){var a=(65535&e)+(65535&r)+(65535&t)+(65535&n)+(65535&o);return((e>>>16)+(r>>>16)+(t>>>16)+(n>>>16)+(o>>>16)+(a>>>16)&65535)<<16|65535&a}function y(e){if("SHA-1"!==e)throw Error("No SHA variants supported");return[1732584193,4023233417,2562383102,271733878,3285377520]}function k(e,r){var t,n,o,a,i,u,s,c=[];for(t=r[0],n=r[1],o=r[2],a=r[3],i=r[4],s=0;80>s;s+=1)c[s]=16>s?e[s]:g(c[s-3]^c[s-8]^c[s-14]^c[s-16],1),u=20>s?E(g(t,5),n&o^~n&a,i,1518500249,c[s]):40>s?E(g(t,5),n^o^a,i,1859775393,c[s]):60>s?E(g(t,5),n&o^n&a^o&a,i,2400959708,c[s]):E(g(t,5),n^o^a,i,3395469782,c[s]),i=a,a=o,o=g(n,30),n=t,t=u;return r[0]=b(t,r[0]),r[1]=b(n,r[1]),r[2]=b(o,r[2]),r[3]=b(a,r[3]),r[4]=b(i,r[4]),r}function A(e,r,t,n){var o;for(o=15+(r+65>>>9<<4);e.length<=o;)e.push(0);for(e[r>>>5]|=128<<24-r%32,r+=t,e[o]=4294967295&r,e[o-1]=r/4294967296|0,r=e.length,o=0;o<r;o+=16)n=k(e.slice(o,o+16),n);return n}void 0!==(n=function(){return a}.call(r,t,r,e))&&(e.exports=n)}()},function(r,t){r.exports=e},function(e,r,t){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function o(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),i=t(1),u=n(i),s=t(0),c=n(s),f=86400,h="/token/access",p=function(){function e(r){var t=this,n=r.address,a=r.appid,i=r.secret_key,u=r.shortid;o(this,e),this.getToken=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:f;return t._promise||(t._promise=Promise.resolve(t.getCacheToken()).catch(function(){return t.generateToken(e)}).catch(function(){return t.access()}).then(function(e){return t._promise=null,t._token=e,e})),t._promise},this.generateToken=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:f;return t.appid&&t.secret_key&&t.shortid?new Promise(function(r){var n=parseInt(Date.now()/1e3,10)+e,o=t.appid+"_"+n+"_"+t.secret_key,a=new c.default("SHA-1","TEXT");a.setHMACKey(t.secret_key,"TEXT"),a.update(o);var i=a.getHMAC("HEX");r([t.shortid,n,i].join(":"))}):Promise.reject("缺少信息，无法生成token")},this.address=n,this.appid=a,this.secret_key=i,this.shortid=u}return a(e,[{key:"access",value:function(){var e=this;return this.address&&this.appid&&this.secret_key?new Promise(function(r,t){u.default.https(e.address,{dataType:"json"},{response:function(e){if(0!==e.Err){var n=new Error(e.Data.desc);n.code=e.Data.code,t(n)}else e.Data&&e.Data.RepDataToken&&r(e.Data.RepDataToken[0].token)},error:t}).request(h+"?appid="+e.appid+"&secret_key="+e.secret_key)}):Promise.reject("缺少信息，无法请求token")}},{key:"getCacheToken",value:function(){var e=this;return new Promise(function(r,t){if(e._token){var n=e._token.split(":")[1]+"000";if(parseInt(n,10)>Date.now())return r(e._token)}return t()})}}]),e}(),d=function e(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=r.address,n=r.appid,a=r.secret_key,i=r.shortid;o(this,e);var u=new p({address:t,appid:n,secret_key:a,shortid:i});this.getToken=u.getToken,this.generateToken=u.generateToken};r.default=d,e.exports=d}])});