!function(e,r){"object"==typeof exports&&"object"==typeof module?module.exports=r(require("dzhyun-connection")):"function"==typeof define&&define.amd?define(["dzhyun-connection"],r):"object"==typeof exports?exports.DzhyunTokenManager=r(require("dzhyun-connection")):e.DzhyunTokenManager=r(e.connection)}(this,function(e){return function(e){function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}var t={};return r.m=e,r.c=t,r.i=function(e){return e},r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},r.p="",r(r.s=2)}([function(e,r,t){"use strict";var n;!function(o){function a(e,r,t){var n,o,a,p,d,l,E,y,k,A=0,w=[],T=0,m=!1,F=[],R=[],U=!1;if(t=t||{},n=t.encoding||"UTF8",(k=t.numRounds||1)!==parseInt(k,10)||1>k)throw Error("numRounds must a integer >= 1");if("SHA-1"!==e)throw Error("Chosen SHA variant is not supported");d=512,l=g,E=b,p=160,y=function(e){return e.slice()},a=h(r,n),o=v(e),this.setHMACKey=function(r,t,a){var i;if(!0===m)throw Error("HMAC key already set");if(!0===U)throw Error("Cannot set HMAC key after calling update");if(n=(a||{}).encoding||"UTF8",t=h(t,n)(r),r=t.binLen,t=t.value,i=d>>>3,a=i/4-1,i<r/8){for(t=E(t,r,0,v(e),p);t.length<=a;)t.push(0);t[a]&=4294967040}else if(i>r/8){for(;t.length<=a;)t.push(0);t[a]&=4294967040}for(r=0;r<=a;r+=1)F[r]=909522486^t[r],R[r]=1549556828^t[r];o=l(F,o),A=d,m=!0},this.update=function(e){var r,t,n,i=0,u=d>>>5;for(r=a(e,w,T),e=r.binLen,t=r.value,r=e>>>5,n=0;n<r;n+=u)i+d<=e&&(o=l(t.slice(n,n+u),o),i+=d);A+=i,w=t.slice(i>>>5),T=e%d,U=!0},this.getHash=function(r,t){var n,a,h,d;if(!0===m)throw Error("Cannot call getHash after setting HMAC key");switch(h=f(t),r){case"HEX":n=function(e){return i(e,p,h)};break;case"B64":n=function(e){return u(e,p,h)};break;case"BYTES":n=function(e){return s(e,p)};break;case"ARRAYBUFFER":try{a=new ArrayBuffer(0)}catch(e){throw Error("ARRAYBUFFER not supported by this environment")}n=function(e){return c(e,p)};break;default:throw Error("format must be HEX, B64, BYTES, or ARRAYBUFFER")}for(d=E(w.slice(),T,A,y(o),p),a=1;a<k;a+=1)d=E(d,p,0,v(e),p);return n(d)},this.getHMAC=function(r,t){var n,a,h,g;if(!1===m)throw Error("Cannot call getHMAC without first setting HMAC key");switch(h=f(t),r){case"HEX":n=function(e){return i(e,p,h)};break;case"B64":n=function(e){return u(e,p,h)};break;case"BYTES":n=function(e){return s(e,p)};break;case"ARRAYBUFFER":try{n=new ArrayBuffer(0)}catch(e){throw Error("ARRAYBUFFER not supported by this environment")}n=function(e){return c(e,p)};break;default:throw Error("outputFormat must be HEX, B64, BYTES, or ARRAYBUFFER")}return a=E(w.slice(),T,A,y(o),p),g=l(R,v(e)),g=E(a,p,d,g,p),n(g)}}function i(e,r,t){var n="";r/=8;var o,a;for(o=0;o<r;o+=1)a=e[o>>>2]>>>8*(3+o%4*-1),n+="0123456789abcdef".charAt(a>>>4&15)+"0123456789abcdef".charAt(15&a);return t.outputUpper?n.toUpperCase():n}function u(e,r,t){var n,o,a,i="",u=r/8;for(n=0;n<u;n+=3)for(o=n+1<u?e[n+1>>>2]:0,a=n+2<u?e[n+2>>>2]:0,a=(e[n>>>2]>>>8*(3+n%4*-1)&255)<<16|(o>>>8*(3+(n+1)%4*-1)&255)<<8|a>>>8*(3+(n+2)%4*-1)&255,o=0;4>o;o+=1)i+=8*n+6*o<=r?"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a>>>6*(3-o)&63):t.b64Pad;return i}function s(e,r){var t,n,o="",a=r/8;for(t=0;t<a;t+=1)n=e[t>>>2]>>>8*(3+t%4*-1)&255,o+=String.fromCharCode(n);return o}function c(e,r){var t,n,o=r/8,a=new ArrayBuffer(o);for(n=new Uint8Array(a),t=0;t<o;t+=1)n[t]=e[t>>>2]>>>8*(3+t%4*-1)&255;return a}function f(e){var r={outputUpper:!1,b64Pad:"=",shakeLen:-1};if(e=e||{},r.outputUpper=e.outputUpper||!1,!0===e.hasOwnProperty("b64Pad")&&(r.b64Pad=e.b64Pad),"boolean"!=typeof r.outputUpper)throw Error("Invalid outputUpper formatting option");if("string"!=typeof r.b64Pad)throw Error("Invalid b64Pad formatting option");return r}function h(e,r){var t;switch(r){case"UTF8":case"UTF16BE":case"UTF16LE":break;default:throw Error("encoding must be UTF8, UTF16BE, or UTF16LE")}switch(e){case"HEX":t=function(e,r,t){var n,o,a,i,u,s=e.length;if(0!=s%2)throw Error("String of HEX type must be in byte increments");for(r=r||[0],t=t||0,u=t>>>3,n=0;n<s;n+=2){if(o=parseInt(e.substr(n,2),16),isNaN(o))throw Error("String of HEX type contains invalid characters");for(i=(n>>>1)+u,a=i>>>2;r.length<=a;)r.push(0);r[a]|=o<<8*(3+i%4*-1)}return{value:r,binLen:4*s+t}};break;case"TEXT":t=function(e,t,n){var o,a,i,u,s,c,f,h,p=0;if(t=t||[0],n=n||0,s=n>>>3,"UTF8"===r)for(h=3,i=0;i<e.length;i+=1)for(o=e.charCodeAt(i),a=[],128>o?a.push(o):2048>o?(a.push(192|o>>>6),a.push(128|63&o)):55296>o||57344<=o?a.push(224|o>>>12,128|o>>>6&63,128|63&o):(i+=1,o=65536+((1023&o)<<10|1023&e.charCodeAt(i)),a.push(240|o>>>18,128|o>>>12&63,128|o>>>6&63,128|63&o)),u=0;u<a.length;u+=1){for(f=p+s,c=f>>>2;t.length<=c;)t.push(0);t[c]|=a[u]<<8*(h+f%4*-1),p+=1}else if("UTF16BE"===r||"UTF16LE"===r)for(h=2,a="UTF16LE"===r&&!0||"UTF16LE"!==r&&!1,i=0;i<e.length;i+=1){for(o=e.charCodeAt(i),!0===a&&(u=255&o,o=u<<8|o>>>8),f=p+s,c=f>>>2;t.length<=c;)t.push(0);t[c]|=o<<8*(h+f%4*-1),p+=2}return{value:t,binLen:8*p+n}};break;case"B64":t=function(e,r,t){var n,o,a,i,u,s,c,f=0;if(-1===e.search(/^[a-zA-Z0-9=+\/]+$/))throw Error("Invalid character in base-64 string");if(o=e.indexOf("="),e=e.replace(/\=/g,""),-1!==o&&o<e.length)throw Error("Invalid '=' found in base-64 string");for(r=r||[0],t=t||0,s=t>>>3,o=0;o<e.length;o+=4){for(u=e.substr(o,4),a=i=0;a<u.length;a+=1)n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(u[a]),i|=n<<18-6*a;for(a=0;a<u.length-1;a+=1){for(c=f+s,n=c>>>2;r.length<=n;)r.push(0);r[n]|=(i>>>16-8*a&255)<<8*(3+c%4*-1),f+=1}}return{value:r,binLen:8*f+t}};break;case"BYTES":t=function(e,r,t){var n,o,a,i,u;for(r=r||[0],t=t||0,a=t>>>3,o=0;o<e.length;o+=1)n=e.charCodeAt(o),u=o+a,i=u>>>2,r.length<=i&&r.push(0),r[i]|=n<<8*(3+u%4*-1);return{value:r,binLen:8*e.length+t}};break;case"ARRAYBUFFER":try{t=new ArrayBuffer(0)}catch(e){throw Error("ARRAYBUFFER not supported by this environment")}t=function(e,r,t){var n,o,a,i,u;for(r=r||[0],t=t||0,o=t>>>3,u=new Uint8Array(e),n=0;n<e.byteLength;n+=1)i=n+o,a=i>>>2,r.length<=a&&r.push(0),r[a]|=u[n]<<8*(3+i%4*-1);return{value:r,binLen:8*e.byteLength+t}};break;default:throw Error("format must be HEX, TEXT, B64, BYTES, or ARRAYBUFFER")}return t}function p(e,r){return e<<r|e>>>32-r}function d(e,r){var t=(65535&e)+(65535&r);return((e>>>16)+(r>>>16)+(t>>>16)&65535)<<16|65535&t}function l(e,r,t,n,o){var a=(65535&e)+(65535&r)+(65535&t)+(65535&n)+(65535&o);return((e>>>16)+(r>>>16)+(t>>>16)+(n>>>16)+(o>>>16)+(a>>>16)&65535)<<16|65535&a}function v(e){if("SHA-1"!==e)throw Error("No SHA variants supported");return[1732584193,4023233417,2562383102,271733878,3285377520]}function g(e,r){var t,n,o,a,i,u,s,c=[];for(t=r[0],n=r[1],o=r[2],a=r[3],i=r[4],s=0;80>s;s+=1)c[s]=16>s?e[s]:p(c[s-3]^c[s-8]^c[s-14]^c[s-16],1),u=20>s?l(p(t,5),n&o^~n&a,i,1518500249,c[s]):40>s?l(p(t,5),n^o^a,i,1859775393,c[s]):60>s?l(p(t,5),n&o^n&a^o&a,i,2400959708,c[s]):l(p(t,5),n^o^a,i,3395469782,c[s]),i=a,a=o,o=p(n,30),n=t,t=u;return r[0]=d(t,r[0]),r[1]=d(n,r[1]),r[2]=d(o,r[2]),r[3]=d(a,r[3]),r[4]=d(i,r[4]),r}function b(e,r,t,n){var o;for(o=15+(r+65>>>9<<4);e.length<=o;)e.push(0);for(e[r>>>5]|=128<<24-r%32,r+=t,e[o]=4294967295&r,e[o-1]=r/4294967296|0,r=e.length,o=0;o<r;o+=16)n=g(e.slice(o,o+16),n);return n}void 0!==(n=function(){return a}.call(r,t,r,e))&&(e.exports=n)}()},function(r,t){r.exports=e},function(e,r,t){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function o(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(r,"__esModule",{value:!0});var a=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),i=t(1),u=n(i),s=t(0),c=n(s),f=86400,h=function(){function e(r){var t=this,n=r.address,a=r.appid,i=r.secret_key,u=r.shortid;o(this,e),this.getToken=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:f;return t._promise||(t._promise=Promise.resolve(t.getCacheToken()).catch(function(){return t.generateToken(e)}).catch(function(){return t.access()}).then(function(e){return t._promise=null,t._token=e,e})),t._promise},this.generateToken=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:f;return t.appid&&t.secret_key&&t.shortid?new Promise(function(r){var n=parseInt(Date.now()/1e3,10)+e,o=t.appid+"_"+n+"_"+t.secret_key,a=new c.default("SHA-1","TEXT");a.setHMACKey(t.secret_key,"TEXT"),a.update(o);var i=a.getHMAC("HEX");r([t.shortid,n,i].join(":"))}):Promise.reject("缺少信息，无法生成token")},this.address=n,this.appid=a,this.secret_key=i,this.shortid=u}return a(e,[{key:"access",value:function(){var e=this;return this.address&&this.appid&&this.secret_key?new Promise(function(r,t){new u.default(e.address,{dataType:"json"},{response:function(e){if(0!==e.Err){var n=new Error(e.Data.desc);n.code=e.Data.code,t(n)}else e.Data&&e.Data.RepDataToken&&r(e.Data.RepDataToken[0].token)},error:t}).request("/token/access?appid="+e.appid+"&secret_key="+e.secret_key)}):Promise.reject("缺少信息，无法请求token")}},{key:"getCacheToken",value:function(){var e=this;return new Promise(function(r,t){if(e._token){var n=e._token.split(":")[1]+"000";if(parseInt(n,10)>Date.now())return r(e._token)}return t()})}}]),e}(),p=function e(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=r.address,n=r.appid,a=r.secret_key,i=r.shortid;o(this,e);var u=new h({address:t,appid:n,secret_key:a,shortid:i});this.getToken=u.getToken,this.generateToken=u.generateToken};r.default=p,e.exports=p}])});